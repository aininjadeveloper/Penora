{% extends "base.html" %}

{% block title %}My Workspace - Penora{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1><i class="fas fa-folder-open me-2"></i>My Workspace</h1>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#saveModal">
                    <i class="fas fa-plus me-2"></i>Save New Project
                </button>
            </div>

            <!-- Storage Stats Card -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <h5 class="card-title"><i class="fas fa-hdd me-2"></i>Storage Usage</h5>
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar {% if storage_stats.usage_percentage > 80 %}bg-danger{% elif storage_stats.usage_percentage > 60 %}bg-warning{% else %}bg-success{% endif %}"
                                    role="progressbar" style="width: {{ storage_stats.usage_percentage }}%"
                                    aria-valuenow="{{ storage_stats.usage_percentage }}" aria-valuemin="0"
                                    aria-valuemax="100">
                                    {{ storage_stats.usage_percentage }}%
                                </div>
                            </div>
                            <small class="text-muted">{{ storage_stats.used_mb }}MB / {{ storage_stats.total_mb }}MB
                                used</small>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="fs-2 fw-bold text-primary">{{ storage_stats.total_projects }}</div>
                            <div class="text-muted">Total Projects</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Projects Grid -->
            {% if projects %}
            <div class="row">
                {% for project in projects %}
                <div class="col-lg-6 col-xl-4 mb-4">
                    <div class="card h-100 shadow-sm border-0 red-glow" style="overflow: visible;">
                        <div
                            class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center mb-0 pb-0">
                            <h6 class="mb-0 text-truncate" title="{{ project.project_title }}">{{ project.project_title
                                }}</h6>
                            <span class="badge bg-secondary">{{ project.code }}</span>
                        </div>
                        <div class="card-body">
                            <p class="card-text text-truncate" style="max-height: 100px; overflow: hidden;">
                                {{ project.generation_text[:150] }}{% if project.generation_text|length > 150 %}...{%
                                endif %}
                            </p>
                            <div class="row text-muted small mb-2">
                                <div class="col-12">
                                    <i class="fas fa-calendar me-1"></i>Created: {{
                                    project.created_at.strftime('%Y-%m-%d %H:%M:%S') }}
                                </div>
                                <div class="col-12">
                                    <i class="fas fa-clock me-1"></i>Updated: {{ project.updated_at.strftime('%Y-%m-%d
                                    %H:%M:%S') }}
                                </div>
                                <div class="col-12">
                                    <i class="fas fa-weight-hanging me-1"></i>Size: {{ project.get_storage_mb() }}MB
                                </div>
                            </div>
                        </div>
                        <div class="card-footer">
                            <div class="d-flex justify-content-between">
                                <button type="button" class="btn btn-sm btn-outline-info"
                                    onclick="viewProject('{{ project.code }}')" title="View">
                                    <i class="fas fa-eye"></i>
                                </button>

                                <a href="{{ url_for('edit_workspace_project', code=project.code) }}"
                                    class="btn btn-sm btn-outline-primary" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </a>

                                <button type="button" class="btn btn-sm btn-outline-success"
                                    onclick="copyProjectText('{{ project.code }}')" title="Copy">
                                    <i class="fas fa-copy"></i>
                                </button>

                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-info dropdown-toggle" type="button"
                                        id="dlDropdown{{ project.code }}" data-bs-toggle="dropdown"
                                        aria-expanded="false" title="Download">
                                        <i class="fas fa-download"></i>
                                    </button>
                                    <ul class="dropdown-menu" aria-labelledby="dlDropdown{{ project.code }}">
                                        <li>
                                            <button class="dropdown-item"
                                                onclick="downloadProject('{{ url_for('download_workspace_project', code=project.code, format='pdf') }}', '{{ project.code }}.pdf')">
                                                <i class="fas fa-file-pdf me-2"></i>PDF
                                            </button>
                                        </li>
                                        <li>
                                            <button class="dropdown-item"
                                                onclick="downloadProject('{{ url_for('download_workspace_project', code=project.code, format='docx') }}', '{{ project.code }}.docx')">
                                                <i class="fas fa-file-word me-2"></i>DOCX
                                            </button>
                                        </li>
                                        <li>
                                            <button class="dropdown-item"
                                                onclick="downloadProject('{{ url_for('download_workspace_project', code=project.code, format='txt') }}', '{{ project.code }}.txt')">
                                                <i class="fas fa-file-alt me-2"></i>TXT
                                            </button>
                                        </li>
                                    </ul>
                                </div>

                                <form action="{{ url_for('delete_workspace_project', code=project.code) }}"
                                    method="POST" class="d-inline">
                                    <button type="submit" class="btn btn-sm btn-outline-danger" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center py-5">
                <i class="fas fa-folder-open fa-3x text-muted mb-3"></i>
                <h4 class="text-muted">No Projects Yet</h4>
                <p class="text-muted">Start generating content and it will automatically be saved to your workspace!</p>
                <a href="{{ url_for('start_writing') }}" class="btn btn-primary me-2">
                    <i class="fas fa-plus me-2"></i>Start Writing
                </a>
                <a href="{{ url_for('start_writing') }}" class="btn btn-outline-primary">
                    <i class="fas fa-book me-2"></i>Generate Story
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
    function copyProjectText(code) {
        // Fetch the full project text and copy it
        fetch(`/workspace/copy/${code}`)
            .then(response => response.json())
            .then(data => {
                if (data.content) {
                    navigator.clipboard.writeText(data.content).then(function () {
                        showToast('Project content copied to clipboard!', 'success');
                    }, function (err) {
                        showToast('Failed to copy content', 'danger');
                    });
                } else {
                    showToast('Failed to fetch project content', 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Error fetching project content', 'danger');
            });
    }

    function viewProject(code) {
        // Fetch and show project in modal
        fetch(`/workspace/copy/${code}`)
            .then(response => response.json())
            .then(data => {
                if (data.content) {
                    // Create and show modal
                    const modal = document.createElement('div');
                    modal.className = 'modal fade';
                    modal.innerHTML = `
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">${data.title}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <pre style="white-space: pre-wrap; max-height: 500px; overflow-y: auto;">${data.content}</pre>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="button" class="btn btn-primary" onclick="copyProjectText('${code}')">Copy Text</button>
                            </div>
                        </div>
                    </div>
                `;
                    document.body.appendChild(modal);
                    const bootstrapModal = new bootstrap.Modal(modal);
                    bootstrapModal.show();
                    modal.addEventListener('hidden.bs.modal', () => modal.remove());
                } else {
                    showToast('Failed to fetch project content', 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Error fetching project content', 'danger');
            });
    }

    function showToast(message, type) {
        const toast = document.createElement('div');
        toast.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        toast.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 300px;';
        toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

        document.body.appendChild(toast);

        setTimeout(() => {
            toast.remove();
        }, 4000);
    }
</script>

<!-- Save New Project Modal -->
<div class="modal fade" id="saveModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('save_to_workspace') }}">
                <div class="modal-header">
                    <h5 class="modal-title">Save New Project</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="title" class="form-label">Project Title</label>
                        <input type="text" class="form-control" id="title" name="title" required maxlength="200">
                    </div>
                    <div class="mb-3">
                        <label for="content" class="form-label">Content</label>
                        <textarea class="form-control" id="content" name="content" rows="10" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Project</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Copy Modal -->
<div class="modal fade" id="copyModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Content Copied!</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Project content has been copied to your clipboard.</p>
                <div class="alert alert-info">
                    <strong>Project:</strong> <span id="copiedTitle"></span><br>
                    <strong>Code:</strong> <span id="copiedCode"></span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->



<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Copy functionality
        document.querySelectorAll('.copy-btn').forEach(btn => {
            btn.addEventListener('click', async function () {
                const code = this.dataset.code;

                try {
                    const response = await fetch(`/workspace/copy/${code}`);
                    const data = await response.json();

                    if (response.ok) {
                        // Copy to clipboard
                        const textToCopy = `Title: ${data.title}\nCode: ${data.code}\n\nContent:\n${data.content}`;
                        await navigator.clipboard.writeText(textToCopy);

                        // Show modal
                        document.getElementById('copiedTitle').textContent = data.title;
                        document.getElementById('copiedCode').textContent = data.code;
                        new bootstrap.Modal(document.getElementById('copyModal')).show();
                    } else {
                        alert('Error copying content: ' + data.error);
                    }
                } catch (error) {
                    alert('Error copying content. Please try again.');
                }
            });
        });
    });
</script>
<script>
    function downloadProject(url, filename) {
        // Show immediate feedback
        if (typeof showToast === 'function') {
            showToast('Download started...', 'info');
        }

        // Create hidden iframe to trigger download via browser native handling
        // This bypasses JS blob saving issues and "new tab" requirements
        const iframe = document.createElement('iframe');
        iframe.style.display = 'none';
        iframe.src = url;
        document.body.appendChild(iframe);

        // Clean up iframe after enough time for the download to start
        setTimeout(() => {
            document.body.removeChild(iframe);
        }, 60000);
    }
</script>
{% endblock %}
```